# WHOIS 查询流程图

## 总体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    Domain-AutoCheck                          │
│                   WHOIS 查询系统架构                          │
└─────────────────────────────────────────────────────────────┘

┌──────────────┐
│   用户界面    │
│  Dashboard   │
└──────┬───────┘
       │
       │ POST /api/whois
       │ { "domain": "example.com" }
       ▼
┌─────────────────────────────────────────────────────────────┐
│                    handleRequest()                           │
│                  _worker.js (主入口)                         │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ 检查认证 (Cookie)
                         ▼
                  ┌──────────────┐
                  │  已认证？     │
                  └──────┬───────┘
                    是   │   否
                ┌────────┴────────┐
                │                 │
                ▼                 ▼
         ┌──────────┐      ┌──────────┐
         │ 继续处理  │      │ 返回 401  │
         └────┬─────┘      └──────────┘
              │
              │ 路由到 API 处理器
              ▼
┌─────────────────────────────────────────────────────────────┐
│                   handleApiRequest()                         │
│                  API 路由处理器                              │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ path === '/api/whois'
                         ▼
┌─────────────────────────────────────────────────────────────┐
│               WHOIS 端点处理器 (5289-5333 行)               │
│                                                              │
│  1. 提取域名参数                                             │
│  2. 验证域名格式 (正则表达式)                                │
│  3. 计算点数和 TLD 检测                                      │
│  4. 选择合适的解析器                                         │
│  5. 返回查询结果                                             │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
                    域名验证
```

---

## 详细流程图

### 阶段 1: 域名验证

```
┌─────────────────────────────────────────────────────────────┐
│                     域名验证流程                             │
└─────────────────────────────────────────────────────────────┘

输入域名: "example.nyc.mn"
    │
    ▼
┌──────────────────────────┐
│  格式验证 (正则表达式)    │  ← domainRegex: /^[a-zA-Z0-9]...$/
└────────┬─────────────────┘
         │ 通过
         ▼
┌──────────────────────────┐
│  计算点数                 │  ← dotCount = domain.split('.').length - 1
│  domain.split('.').length │
│  ["example","nyc","mn"]   │
│  dotCount = 2             │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│  TLD 检测                 │
│  lowerDomain = 小写化     │
└────────┬─────────────────┘
         │
         ▼
┌─────────────────────────────────────────────┐
│          检查特殊 TLD                        │
│                                             │
│  isPpUa = endsWith('.pp.ua')   → false     │
│  isDigitalPlat =                           │
│    endsWith('.qzz.io')         → false     │
│    endsWith('.dpdns.org')      → false     │
│    endsWith('.us.kg')          → false     │
│    endsWith('.xx.kg')          → false     │
│  isNycMn = endsWith('.nyc.mn') → ❌ 未实现  │
└────────┬────────────────────────────────────┘
         │
         ▼
┌──────────────────────────┐
│  验证点数规则             │
│  if (dotCount !== 1 &&   │
│      !((isPpUa ||        │
│         isDigitalPlat) && │
│        dotCount === 2))  │
└────────┬─────────────────┘
         │
    dotCount=2, isPpUa=false, isDigitalPlat=false
    2 !== 1 && !((false || false) && 2 === 2)
    true && !(false && true)
    true && true = true
         │
         ▼
┌──────────────────────────┐
│  ❌ 验证失败              │
│  返回错误:                │
│  "只能查询一级域名，      │
│   不支持二级域名查询"     │
└──────────────────────────┘
```

### 阶段 2: 解析器选择

```
┌─────────────────────────────────────────────────────────────┐
│                   解析器选择决策树                           │
└─────────────────────────────────────────────────────────────┘

域名验证通过
    │
    ▼
┌───────────────────┐
│ isPpUa = true?    │
└─────┬─────────────┘
      │ 是
      ▼
┌─────────────────────────────┐        ┌──────────────────────┐
│  queryPpUaWhois(domain)     │        │  NIC.UA API          │
│  (第 104-168 行)            │───────▶│  nic.ua/whois-info   │
└─────────────────────────────┘        └──────────────────────┘
      │ 否
      ▼
┌───────────────────┐
│ isNycMn = true?   │  ← ❌ 当前未实现
└─────┬─────────────┘
      │ 是
      ▼
┌─────────────────────────────┐        ┌──────────────────────┐
│  queryNycMnWhois(domain)    │        │  蒙古 NIC API        │
│  (需要实现)                  │───────▶│  或 WHOIS API        │
└─────────────────────────────┘        └──────────────────────┘
      │ 否
      ▼
┌──────────────────────────┐
│ isDigitalPlat = true?    │
└─────┬────────────────────┘
      │ 是
      ▼
┌─────────────────────────────┐        ┌──────────────────────┐
│ queryDigitalPlatWhois(...)  │        │  DigitalPlat API     │
│ (第 171-241 行)             │───────▶│  via corsproxy.io    │
└─────────────────────────────┘        └──────────────────────┘
      │ 否
      ▼
┌─────────────────────────────┐        ┌──────────────────────┐
│  queryDomainWhois(domain)   │        │  WhoisJSON API       │
│  (第 55-101 行)             │───────▶│  whoisjson.com       │
│  【默认解析器】              │        │  需要 API Key        │
└─────────────────────────────┘        └──────────────────────┘
```

---

## 解析器详细架构

### queryPpUaWhois - PP.UA 解析器

```
┌─────────────────────────────────────────────────────────────┐
│                    queryPpUaWhois                            │
│                   (第 104-168 行)                            │
└─────────────────────────────────────────────────────────────┘

输入: "example.pp.ua"
    │
    ▼
┌──────────────────────────┐
│  发送 HTTP GET 请求       │
│  URL: nic.ua/en/whois-   │
│       info?domain_name=  │
│  Headers:                │
│    - X-Requested-With    │
│    - User-Agent          │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│  接收 JSON 响应           │
│  { whois_info: "..." }   │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│  文本解析                 │
│  使用正则表达式提取:      │
│  - Created On            │
│  - Expiration Date       │
│  - Last Updated On       │
│  - Sponsoring Registrar  │
│  - Name Server (多个)    │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│  格式化响应               │
│  {                       │
│    success: true,        │
│    domain: "...",        │
│    registered: true,     │
│    registrationDate,     │
│    expiryDate,           │
│    ...                   │
│  }                       │
└────────┬─────────────────┘
         │
         ▼
    返回给调用者
```

### queryDigitalPlatWhois - DigitalPlat 解析器

```
┌─────────────────────────────────────────────────────────────┐
│                 queryDigitalPlatWhois                        │
│                   (第 171-241 行)                            │
└─────────────────────────────────────────────────────────────┘

输入: "example.us.kg"
    │
    ▼
┌──────────────────────────┐
│  构造目标 URL             │
│  dash.domain.            │
│  digitalplat.org/whois   │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│  通过 CORS 代理           │
│  corsproxy.io/?url=...   │
│  (避免 TLS 问题)          │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│  接收文本响应             │
│  (纯文本 WHOIS 格式)      │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│  检查 "Domain not found" │
└────────┬─────────────────┘
    未找到 │ 找到
     ├─────┴──────┐
     │            │
     ▼            ▼
┌─────────┐  ┌──────────────────────────┐
│未注册   │  │  文本解析                 │
│响应     │  │  提取:                    │
└─────────┘  │  - Creation Date         │
             │  - Registry Expiry Date  │
             │  - Registrar             │
             │  - Name Server           │
             └────────┬─────────────────┘
                      │
                      ▼
             ┌──────────────────────────┐
             │  格式化响应               │
             └────────┬─────────────────┘
                      │
                      ▼
                 返回给调用者
```

### queryDomainWhois - WhoisJSON 解析器

```
┌─────────────────────────────────────────────────────────────┐
│                   queryDomainWhois                           │
│                    (第 55-101 行)                            │
└─────────────────────────────────────────────────────────────┘

输入: "example.com"
    │
    ▼
┌──────────────────────────┐
│  检查 API Key             │
│  WHOISJSON_API_KEY       │
└────────┬─────────────────┘
    未配置 │ 已配置
     ├─────┴──────┐
     │            │
     ▼            ▼
┌─────────┐  ┌──────────────────────────┐
│抛出错误 │  │  发送 HTTP GET 请求       │
└─────────┘  │  URL: whoisjson.com/     │
             │       api/v1/whois       │
             │  Headers:                │
             │    - Authorization:      │
             │      Token=...           │
             └────────┬─────────────────┘
                      │
                      ▼
             ┌──────────────────────────┐
             │  接收 JSON 响应           │
             │  (结构化数据)             │
             │  {                       │
             │    name: "...",          │
             │    registered: true,     │
             │    created: "...",       │
             │    expires: "...",       │
             │    registrar: {...}      │
             │  }                       │
             └────────┬─────────────────┘
                      │
                      ▼
             ┌──────────────────────────┐
             │  直接格式化               │
             │  (无需解析文本)           │
             └────────┬─────────────────┘
                      │
                      ▼
                 返回给调用者
```

---

## 问题定位图

### nyc.mn 问题流程

```
┌─────────────────────────────────────────────────────────────┐
│                  nyc.mn 问题追踪                             │
└─────────────────────────────────────────────────────────────┘

用户输入: "example.nyc.mn"
    │
    ▼
第 5304 行: dotCount = 2
第 5306 行: isPpUa = false (不以 .pp.ua 结尾)
第 5307 行: isDigitalPlat = false (不在列表中)
    │
    │         ❌ 问题根源: 缺少 .nyc.mn 检测
    │
    ▼
第 5309 行: 验证条件判断
    │
    │  if (dotCount !== 1 && !((isPpUa || isDigitalPlat) && dotCount === 2))
    │  if (2 !== 1 && !((false || false) && 2 === 2))
    │  if (true && !(false && true))
    │  if (true && true)
    │  if (true)  ← 条件成立
    │
    ▼
第 5313 行: 返回错误
    │
    ▼
┌──────────────────────────┐
│  响应:                   │
│  {                       │
│    error: "只能查询一级   │
│           域名，不支持    │
│           二级域名查询"   │
│  }                       │
└──────────────────────────┘
    │
    ▼
用户看到错误 ❌
```

### de TLD 问题流程

```
┌─────────────────────────────────────────────────────────────┐
│                    de TLD 问题追踪                           │
└─────────────────────────────────────────────────────────────┘

用户输入: "example.de"
    │
    ▼
第 5304 行: dotCount = 1 ✅
第 5306 行: isPpUa = false
第 5307 行: isDigitalPlat = false
    │
    ▼
第 5309 行: 验证条件判断
    │
    │  if (1 !== 1 && ...)
    │  if (false && ...)
    │  条件不成立 ✅
    │
    ▼
第 5317-5327 行: 解析器选择
    │
    │  isPpUa = false
    │  isDigitalPlat = false
    │  进入 else 分支 → queryDomainWhois
    │
    ▼
第 55-101 行: queryDomainWhois("example.de")
    │
    ▼
发送请求到 WhoisJSON API
    │
    ├───────────────────────────────┐
    │                               │
    ▼                               ▼
API 支持 .de                   API 不支持 .de
    │                               │
    │                               │
    ▼                               ▼
┌────────────┐              ┌─────────────┐
│ 返回数据    │              │ 返回错误     │
│ (可能部分   │              │ - 4xx 错误   │
│  字段被     │              │ - 不支持 TLD │
│  GDPR 隐藏) │              │ - 或超时     │
└────────────┘              └─────────────┘
    │                               │
    ▼                               ▼
成功（但信息有限）            失败 ❌

         ⚠️ 问题根源:
         1. WhoisJSON 可能不支持 .de
         2. DENIC 有 GDPR 限制
         3. 没有备用解析器
```

---

## 修复后的流程 (建议)

### 修复 nyc.mn 后的流程

```
┌─────────────────────────────────────────────────────────────┐
│               修复后: nyc.mn 查询流程                        │
└─────────────────────────────────────────────────────────────┘

用户输入: "example.nyc.mn"
    │
    ▼
第 5304 行: dotCount = 2
第 5306 行: isPpUa = false
第 5307 行: isDigitalPlat = false
🆕 第 5308 行: isNycMn = true ✅  ← 新增检测
    │
    ▼
第 5309 行: 验证条件判断 (已修改)
    │
    │  if (dotCount !== 1 && !((isPpUa || isDigitalPlat || isNycMn) && dotCount === 2))
    │  if (2 !== 1 && !((false || false || true) && 2 === 2))
    │  if (true && !(true && true))
    │  if (true && false)
    │  if (false)  ← 条件不成立 ✅
    │
    ▼
验证通过 → 进入解析器选择
    │
    ▼
第 5317-5327 行: 解析器选择 (已修改)
    │
    │  isPpUa = false
    │  🆕 isNycMn = true → 进入新分支
    │
    ▼
🆕 queryNycMnWhois("example.nyc.mn")
    │
    ▼
查询蒙古 NIC 或使用备用 API
    │
    ▼
┌──────────────────────────┐
│  成功返回 WHOIS 信息      │
│  {                       │
│    success: true,        │
│    domain: "...",        │
│    registrationDate,     │
│    expiryDate,           │
│    ...                   │
│  }                       │
└──────────────────────────┘
    │
    ▼
用户看到完整信息 ✅
```

---

## 数据流图

```
┌─────────────────────────────────────────────────────────────┐
│                      数据流向图                              │
└─────────────────────────────────────────────────────────────┘

[前端 UI]
    │
    │ 用户输入域名
    │
    ▼
[验证层]
    ├─ 格式验证
    ├─ 点数验证
    └─ TLD 检测
    │
    │ 验证通过
    │
    ▼
[路由层]
    ├─ isPpUa? → [NIC.UA 解析器]
    ├─ isNycMn? → [蒙古 NIC 解析器] (建议新增)
    ├─ isDigitalPlat? → [DigitalPlat 解析器]
    └─ else → [WhoisJSON 解析器]
    │
    │
    ▼
[解析层]
    ├─ 发送 API 请求
    ├─ 接收响应
    ├─ 解析数据
    └─ 格式化输出
    │
    │
    ▼
[响应层]
    └─ 标准化 JSON 格式
        {
          success: bool,
          domain: string,
          registered: bool,
          registrationDate: string,
          expiryDate: string,
          ...
        }
    │
    │
    ▼
[前端 UI]
    └─ 显示结果或错误
```

---

## 系统集成图

```
┌─────────────────────────────────────────────────────────────┐
│                  完整系统集成架构                            │
└─────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│                    Cloudflare Workers                         │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                   _worker.js                             │ │
│  │                                                          │ │
│  │  ┌──────────────────────────────────────────────────┐  │ │
│  │  │           handleRequest() - 主路由           │  │ │
│  │  └──────────────────┬───────────────────────────────┘  │ │
│  │                     │                                   │ │
│  │  ┌──────────────────▼───────────────────────────────┐  │ │
│  │  │          handleApiRequest() - API 路由           │  │ │
│  │  └──────────────────┬───────────────────────────────┘  │ │
│  │                     │                                   │ │
│  │  ┌──────────────────▼───────────────────────────────┐  │ │
│  │  │           WHOIS 端点处理器                       │  │ │
│  │  │  - 验证域名                                      │  │ │
│  │  │  - TLD 检测                                      │  │ │
│  │  │  - 解析器选择                                    │  │ │
│  │  └──────┬──────────┬──────────┬──────────┬─────────┘  │ │
│  │         │          │          │          │             │ │
│  │         ▼          ▼          ▼          ▼             │ │
│  │  ┌──────────┐ ┌─────────┐ ┌──────────┐ ┌──────────┐  │ │
│  │  │ PP.UA    │ │ Nyc.Mn  │ │ Digital  │ │ WhoisJSON│  │ │
│  │  │ 解析器    │ │ 解析器  │ │ Plat     │ │ 解析器   │  │ │
│  │  │          │ │ (建议)  │ │ 解析器   │ │ (默认)   │  │ │
│  │  └────┬─────┘ └────┬────┘ └────┬─────┘ └────┬─────┘  │ │
│  └───────┼────────────┼───────────┼────────────┼────────┘ │
│          │            │           │            │          │
└──────────┼────────────┼───────────┼────────────┼──────────┘
           │            │           │            │
           ▼            ▼           ▼            ▼
    ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐
    │ NIC.UA   │ │ 蒙古 NIC  │ │ corsproxy│ │WhoisJSON │
    │   API    │ │   或备用  │ │   代理   │ │   API    │
    │          │ │   API    │ │   服务   │ │          │
    └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘
         │            │            │            │
         │            │            │            │
         │            │            ▼            │
         │            │     ┌──────────────┐   │
         │            │     │ DigitalPlat  │   │
         │            │     │   WHOIS API  │   │
         │            │     └──────────────┘   │
         │            │                        │
         └────────────┴────────────────────────┘
                      │
                      ▼
              标准化 WHOIS 响应
                      │
                      ▼
              返回给 Cloudflare Workers
                      │
                      ▼
              返回给前端用户
```

---

## 决策树 - 选择修复方案

```
需要修复 WHOIS 查询问题
    │
    ▼
┌────────────────────────────────────┐
│  哪个 TLD 有问题?                   │
└─────┬──────────────────────────────┘
      │
      ├─────────────────────────┬──────────────────────────┐
      ▼                         ▼                          ▼
  .nyc.mn                    .de                      其他 TLD
      │                         │                          │
      ▼                         ▼                          ▼
┌─────────────┐         ┌─────────────┐         ┌──────────────┐
│是二级域名?  │         │是一级域名?  │         │检查 TLD 类型 │
│  是         │         │  是         │         └──────┬───────┘
└──────┬──────┘         └──────┬──────┘                │
       │                       │                       │
       ▼                       ▼                       │
┌─────────────┐         ┌─────────────┐               │
│添加到白名单  │         │测试 WhoisJSON│              │
│并实现解析器  │         │ 是否支持    │               │
└──────┬──────┘         └──────┬──────┘               │
       │                       │                       │
       │                   支持? 不支持                │
       │                   │      │                   │
       │                   ▼      ▼                   │
       │            ┌───────┐ ┌──────────┐            │
       │            │无需修改│ │添加专用  │            │
       │            │       │ │解析器    │            │
       │            └───────┘ └──────────┘            │
       │                                              │
       └──────────────────┬───────────────────────────┘
                          │
                          ▼
                  ┌─────────────┐
                  │ 实施并测试   │
                  └─────────────┘
```

---

## 错误处理流程

```
┌─────────────────────────────────────────────────────────────┐
│                    错误处理流程                              │
└─────────────────────────────────────────────────────────────┘

WHOIS 查询开始
    │
    ├───────────────────┬──────────────────┬──────────────────┐
    │                   │                  │                  │
    ▼                   ▼                  ▼                  ▼
格式验证失败      TLD 不支持         API 调用失败      解析失败
    │                   │                  │                  │
    ▼                   ▼                  ▼                  ▼
┌─────────┐     ┌──────────┐      ┌──────────┐      ┌─────────┐
│返回 400 │     │返回 400  │      │返回 500  │      │返回 500 │
│错误信息:│     │错误信息: │      │错误信息: │      │错误信息:│
│格式不正确│     │不支持的  │      │API 请求  │      │解析数据 │
│         │     │TLD      │      │失败      │      │失败     │
└─────────┘     └──────────┘      └──────────┘      └─────────┘
    │                   │                  │                  │
    └───────────────────┴──────────────────┴──────────────────┘
                          │
                          ▼
                  记录到日志/监控
                          │
                          ▼
                  返回给前端 UI
                          │
                          ▼
                  显示友好的错误提示
```

---

**文档版本**: 1.0  
**创建日期**: 2025年  
**用途**: 可视化 WHOIS 查询系统架构和流程
